    public function allGrades(Request $request)
    {
        $user = Auth::user();
        $allGrades = new Collection();

        $professorCourseOfferings = CourseOffering::where('lecturer_user_id', $user->id)->pluck('id');

        $assignmentGrades = Submission::whereHas('assignment', function($query) use ($professorCourseOfferings) {
                                            $query->whereIn('course_offering_id', $professorCourseOfferings);
                                        })
                                        ->whereNotNull('grade_received')
                                        ->with('assignment.courseOffering.course', 'student.profile')
                                        ->get()
                                        ->map(function ($submission) {
                                            $assignmentTitle = $submission->assignment->title_km ?? $submission->assignment->title_en ?? 'N/A';

                                            $courseTitle = $submission->assignment->courseOffering->course->title_km ?? 'N/A';
                                            $maxScore = $submission->assignment->max_score ?? 0;

                                            return (object)[
                                                'type' => 'assignment',
                                                'course_title_km' => $courseTitle,
                                                'course_title_en' => $submission->assignment->courseOffering->course->title_en ?? 'N/A',
                                                'assessment_type' => 'កិច្ចការស្រាវជ្រាវ: ' . $assignmentTitle,
                                                'student_name' => $submission->student->profile->full_name_km ?? $submission->student->name,
                                                'score' => $submission->grade_received,
                                                // 'score' => $result->score_obtained,
                                                'max_score' => $maxScore,
                                                'date' => $submission->updated_at,
                                            ];
                                        });
        $allGrades = $allGrades->concat($assignmentGrades);

        // 2. Fetch Exam Grades from their courses
        $examGrades = ExamResult::whereHas('exam', function($query) use ($professorCourseOfferings) {
                                            $query->whereIn('course_offering_id', $professorCourseOfferings);
                                        })
                                        ->whereNotNull('score_obtained')
                                        ->with('exam.courseOffering.course', 'student.profile')
                                        ->get()
                                        ->map(function ($result) {
                                            $examTitle = $result->exam->title_km ?? $result->exam->title_en ?? 'N/A';
                                            $courseTitle = $result->exam->courseOffering->course->title_km ?? 'N/A';
                                            $maxScore = $result->exam->max_score ?? 0;

                                            return (object)[
                                                'type' => 'exam',
                                                'course_title_km' => $courseTitle,
                                                'course_title_en' => $result->exam->courseOffering->course->title_en ?? 'N/A',
                                                'assessment_type' => 'ប្រឡង: ' . $examTitle,
                                                'student_name' => $result->student->profile->full_name_km ?? $result->student->name,
                                                'score' => $result->score_obtained,
                                                'max_score' => $maxScore,
                                                'date' => $result->updated_at,
                                            ];
                                        });
        $allGrades = $allGrades->concat($examGrades);

        // 3. Fetch Quiz Grades (Requires calculation per quiz for students in their courses)
        $quizzesTaught = Quiz::whereIn('course_offering_id', $professorCourseOfferings)
                                ->with(['courseOffering.course', 'quizQuestions.studentQuizResponses.student.profile'])
                                ->get();

        $quizGrades = new Collection();
        foreach ($quizzesTaught as $quiz) {
            $studentResponsesInQuiz = collect();
            foreach ($quiz->quizQuestions as $question) {
                $studentResponsesInQuiz = $studentResponsesInQuiz->concat($question->studentQuizResponses);
            }

            $studentResponsesInQuiz->groupBy('student_user_id')->each(function ($responses, $studentUserId) use ($quiz, &$quizGrades) {
                $student = User::find($studentUserId);
                if (!$student) return;

                $correctAnswers = 0;
                $totalQuestions = $quiz->quizQuestions->count();
                $totalPossibleScore = $quiz->max_score ?? ($totalQuestions > 0 ? $quiz->quizQuestions->sum('points') : 0);
                if ($totalPossibleScore === 0 && $totalQuestions > 0) {
                    $totalPossibleScore = $totalQuestions * 10; 
                }

                foreach ($responses as $response) {
                    if ($response->is_correct) {
                        $correctAnswers += $response->quizQuestion->points ?? 0;
                    }
                }

                $score = $correctAnswers;

                $quizGrades->push((object)[
                    'type' => 'quiz',
                    'course_title_km' => $quiz->courseOffering->course->title_km ?? 'N/A',
                    'course_title_en' => $quiz->courseOffering->course->title_en ?? 'N/A',
                    'assessment_type' => 'Quiz: ' . ($quiz->title_km ?? $quiz->title_en ?? 'N/A'),
                    'student_name' => $student->profile->full_name_km ?? $student->name,
                    'score' => round($score, 2),
                    'max_score' => $totalPossibleScore,
                    'date' => $responses->max('updated_at'), 
                ]);
            });
        }
        $allGrades = $allGrades->concat($quizGrades);


        $allGrades = $allGrades->sortByDesc('date');

        $perPage = 10;
        $currentPage = LengthAwarePaginator::resolveCurrentPage('gradesPage');
        $currentItems = $allGrades->slice(($currentPage - 1) * $perPage, $perPage)->values()->all();
        $grades = new LengthAwarePaginator($currentItems, $allGrades->count(), $perPage, $currentPage, [
            'path' => $request->url(),
            'pageName' => 'gradesPage',
        ]);
    $studentAttendanceScores = collect($courseOffering->studentEnrollments)->mapWithKeys(function ($enrollment) {
    $attendanceRecords = \App\Models\AttendanceRecord::where('student_enrollment_id', $enrollment->id)->get();
    $totalAttended = $attendanceRecords->where('status', 'មានវត្តមាន')->count();
    $totalSessions = 15; 
    $score = ($totalAttended / $totalSessions) * 10;

    return [$enrollment->id => min($score, 10)]; 
    });
    $attendanceAssessment = (object) [
        'id' => 'attendance-grade',
        'title_km' => 'វត្តមាន',
        'title_en' => 'Attendance',
        'max_score' => 10,
        'assessment_type' => 'វត្តមាន',
        'course_offering_id' => $courseOffering->id,
        'is_attendance' => true,
    ];

    $assessments->prepend($attendanceAssessment);

        return view('professor.all-grades', compact('grades','courseOffering', 'students', 'assessments', 'gradebook'));
    }

    public function showGrades(CourseOffering $courseOffering)
    {

        $students = $courseOffering->students()->with([
            'userProfile',
            'submissions' => function ($query) use ($courseOffering) {
                $query->whereIn('assignment_id', $courseOffering->assignments->pluck('id'));
            },
            'examResults' => function ($query) use ($courseOffering) {
                $query->whereIn('exam_id', $courseOffering->exams->pluck('id'));
            },
            'studentQuizResponses.quizQuestion.quiz', // Added for Quiz scores
            'attendanceRecords' => function ($query) use ($courseOffering) {
                $query->where('course_offering_id', $courseOffering->id);
            }
        ])->get();

        $totalSessions = Schedule::where('course_offering_id', $courseOffering->id)->count();

        foreach ($students as $student) {
            $presentCount = $student->attendanceRecords->where('status', 'present')->count();
            $attendancePercentage = ($totalSessions > 0) ? ($presentCount / $totalSessions) * 100 : 0;
            $attendanceScore = ($attendancePercentage / 100) * 10;
            $student->attendance_score = round($attendanceScore, 2);
        }

        $assessments = $courseOffering->assessments()->get();

        return view('professor.grades.index', compact(
            'courseOffering',
            'students',
            'assessments'
        ));
    }

    
    public function allAssignments(Request $request)
    {
        $user = Auth::user();
        $assignments = Assignment::whereHas('courseOffering', function ($query) use ($user) {
                                            $query->where('lecturer_user_id', $user->id);
                                        })
                                        ->with('courseOffering.course')
                                        ->orderBy('due_date', 'desc')
                                        ->paginate(10, ['*'], 'assignmentsPage');

        return view('professor.all-assignments', compact('assignments'));
    }

    /**
     * Display all exams managed by the professor across all their courses.
     */
    public function allExams(Request $request)
    {
        $user = Auth::user();
        $exams = Exam::whereHas('courseOffering', function ($query) use ($user) {
                                $query->where('lecturer_user_id', $user->id);
                            })
                            ->with('courseOffering.course')
                            ->orderBy('exam_date', 'desc')
                            ->paginate(10, ['*'], 'examsPage');

        return view('professor.all-exams', compact('exams'));
    }

    /**
     * Display all attendance records managed by the professor across all their courses.
     */
    public function allAttendance(Request $request)
    {
        $user = Auth::user();
        $attendances = AttendanceRecord::whereHas('courseOffering', function ($query) use ($user) {
                                            $query->where('lecturer_user_id', $user->id);
                                        })
                                        ->with('courseOffering.course', 'student.profile')
                                        ->orderBy('date', 'desc')
                                        ->paginate(10, ['*'], 'attendancePage');

        $attendances->each(function ($record) {
            $record->status_km = match($record->status) {
                'present' => 'មានវត្តមាន',
                'absent' => 'អវត្តមាន',
                'late' => 'មកយឺត',
                'excused' => 'មានច្បាប់',
                default => 'មិនស្គាល់',
            };
        });

        return view('professor.manage-attendance', compact('attendances'));
    }









    /**
     * Manage assignments for a specific course offering.
     */

    // NEW METHODS FOR QUIZ QUESTIONS - START
    // --------------------------------------------------------------------------









// professor.grades.store

    public function editAssignment($offering_id, Assignment $assignment)
    {
        $courseOffering = CourseOffering::findOrFail($offering_id);
        return view('professor.assignments.edit', compact('assignment', 'courseOffering'));
    }

/**
 * NEW: Update the specified assignment in storage.
 */
    public function updateAssignment(Request $request, $offering_id, Assignment $assignment)
    {
        $courseOffering = CourseOffering::findOrFail($offering_id);

        $request->validate([
            'title_km' => 'required|string|max:255',
            'title_en' => 'nullable|string|max:255',
            'description_km' => 'nullable|string',
            'description_en' => 'nullable|string',
            'due_date' => 'required|date',
            'max_score' => 'required|numeric|min:0',
        ]);

        $assignment->update($request->all());

        return redirect()->route('professor.manage-assignments', ['offering_id' => $offering_id])
                        ->with('success', 'កិច្ចការផ្ទះត្រូវបានកែសម្រួលដោយជោគជ័យ!');
    }

    /**
 * NEW: Remove the specified assignment from storage.
 */
    public function destroyAssignment($offering_id, Assignment $assignment)
    {
        
        $assignment->submissions()->delete();

        $assignment->delete();

        return redirect()->route('professor.manage-assignments', ['offering_id' => $offering_id])
                        ->with('success', 'កិច្ចការផ្ទះត្រូវបានលុបដោយជោគជ័យ!');
    }

    public function editExam($offering_id, Exam $exam)
    {
        $courseOffering = CourseOffering::findOrFail($offering_id);
        return view('professor.exams.edit', compact('exam', 'courseOffering'));
    }

/**
 * Update the specified exam in storage.
 */
    public function updateExam(Request $request, $offering_id, Exam $exam)
    {
        $courseOffering = CourseOffering::findOrFail($offering_id);

        $validatedData = $request->validate([
            'title_km' => 'required|string|max:255',
            'title_en' => 'required|string|max:255',
            'description_km' => 'nullable|string',
            'description_en' => 'nullable|string',
            'exam_date' => 'required|date',
            'duration_minutes' => 'required|integer|min:10',
            'max_score' => 'required|numeric|min:0',
        ]);

        $exam->update($validatedData);

        return redirect()->route('professor.manage-exams', ['offering_id' => $offering_id])
                        ->with('success', 'ការប្រលងត្រូវបានកែសម្រួលដោយជោគជ័យ!');
    }

/**
 * Remove the specified exam from storage.
 */
    public function destroyExam($offering_id, Exam $exam)
    {
        $courseOffering = CourseOffering::findOrFail($offering_id);
        $exam->delete();

        return redirect()->route('professor.manage-exams', ['offering_id' => $offering_id])
                        ->with('success', 'ការប្រលងត្រូវបានលុបដោយជោគជ័យ!');
    }
