<x-app-layout>

<x-slot name="header">
    <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold text-gray-900 leading-tight">
            {{ __('បង្កើតអ្នកប្រើប្រាស់ថ្មី') }} <i class="fas fa-user-plus text-green-600 ml-4"></i>
        </h2>
        <a href="{{ route('admin.manage-users') }}" class="px-3 md:px-5 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition">
            
            <span class="md:hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0a9 9 0 01-18 0z" />
                </svg>
            </span>

            <span class="hidden md:inline-block">
                &larr; {{ __('ត្រឡប់ទៅបញ្ជីវិញ') }}
            </span>
        </a>
    </div>
</x-slot>
    <div class="py-12 bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen">
        <div class="max-w-5xl mx-auto sm:px-6 lg:px-10">
            <div class="bg-white overflow-hidden shadow-2xl sm:rounded-3xl p-8 sm:p-10 lg:p-12 border border-gray-200">
                <h3 class="text-3xl font-extrabold text-green-700 mb-8 text-center">{{ __('ព័ត៌មានលម្អិតអ្នកប្រើប្រាស់ថ្មី') }}</h3>

        <form method="POST" action="{{ route('admin.store-user') }}" enctype="multipart/form-data"
            x-data="{ 
                userRole: '{{ old('role', 'professor') }}',
                profilePicturePreview: null,
                
                updateDepartments(facultyId) {
                    const departmentSelect = document.getElementById('department_id');
                    if (!departmentSelect) return;

                    departmentSelect.innerHTML = '<option value=\'\'>{{ __("កំពុងទាញយក...") }}</option>';
                    departmentSelect.disabled = true;

                    fetch(`/admin/get-departments-by-faculty/${facultyId}`)
                        .then(response => response.json())
                        .then(departments => {
                            departmentSelect.innerHTML = '<option value=\'\'>{{ __("ជ្រើសរើសដេប៉ាតឺម៉ង់") }}</option>';
                            departments.forEach(dept => {
                                const option = document.createElement('option');
                                option.value = dept.id;
                                option.textContent = dept.name_km || dept.name_en;
                                departmentSelect.appendChild(option);
                            });
                            departmentSelect.disabled = false;
                        })
                        .catch(error => {
                            console.error('Error fetching departments:', error);
                            departmentSelect.disabled = false;
                        });
                }
            }" class="space-y-8">
            @csrf

            <div class="space-y-6">
                <div class="mb-6">
                    <x-input-label for="name" class="flex items-center text-lg text-gray-700 font-semibold mb-2">
                        <i class="fas fa-user-alt mr-3 text-green-500"></i> {{ __('ឈ្មោះអ្នកប្រើប្រាស់') }}
                    </x-input-label>
                    <x-text-input id="name" class="block w-full rounded-xl py-3 px-4" type="text" name="name" :value="old('name')" required autofocus autocomplete="name" />
                    <x-input-error :messages="$errors->get('name')" class="mt-2" />
                </div>
                <div class="mb-6">
                    <x-input-label for="role" class="flex items-center text-lg text-gray-700 font-semibold mb-2">
                        <i class="fas fa-user-tag mr-3 text-green-500"></i> {{ __('តួនាទី') }}
                    </x-input-label>
                    <select id="role" name="role" x-model="userRole" class="block w-full rounded-xl py-3 px-4" required>
                        <option value="admin">{{ __('Admin') }}</option>
                        <option value="professor">{{ __('Professor') }}</option>
                        <option value="student">{{ __('Student') }}</option>
                    </select>
                    <x-input-error :messages="$errors->get('role')" class="mt-2" />
                </div>
            </div>

            <div class="border-t border-gray-200/50 pt-8 mt-8">
                <template x-if="userRole === 'admin' || userRole === 'professor'">
                    <div class="space-y-6">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4">{{ __('ព័ត៌មានគណនី') }}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <x-input-label for="email" class="flex items-center text-lg text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-envelope mr-3 text-green-500"></i> {{ __('អ៊ីម៉ែល') }}
                                </x-input-label>
                                <x-text-input id="email" class="block w-full rounded-xl py-3 px-4" type="email" name="email" :value="old('email')" required autocomplete="username" />
                                <x-input-error :messages="$errors->get('email')" class="mt-2" />
                            </div>

                            <div class="relative">
                                <x-input-label for="password" class="flex items-center text-lg text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-lock mr-3 text-green-500"></i> {{ __('ពាក្យសម្ងាត់') }}
                                </x-input-label>
                                <x-text-input id="password" type="password" name="password" required autocomplete="new-password" 
                                    class="block w-full rounded-xl py-3 px-4 pr-12 bg-[#0F1629] text-white border border-gray-600 focus:ring-2 focus:ring-blue-500" />
                                <button type="button" @click="const el = document.getElementById('password'); el.type = el.type === 'password' ? 'text' : 'password'" 
                                    class="absolute top-11 right-4 flex items-center text-gray-400 hover:text-white">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                                <x-input-error :messages="$errors->get('password')" class="mt-2" />
                            </div>

                            <div class="relative">
                                <x-input-label for="password_confirmation" class="flex items-center text-lg text-gray-700 font-semibold mb-2">
                                    <i class="fas fa-check-circle mr-3 text-green-500"></i> {{ __('បញ្ជាក់ពាក្យសម្ងាត់') }}
                                </x-input-label>
                                <x-text-input id="password_confirmation" type="password" name="password_confirmation" required autocomplete="new-password" 
                                    class="block w-full rounded-xl py-3 px-4 pr-12 bg-[#0F1629] text-white border border-gray-600 focus:ring-2 focus:ring-blue-500" />
                                <button type="button" @click="const el = document.getElementById('password_confirmation'); el.type = el.type === 'password' ? 'text' : 'password'" 
                                    class="absolute top-11 right-4 flex items-center text-gray-400 hover:text-white">
                                    <i class="fa-solid fa-eye"></i>
                                </button>
                                <x-input-error :messages="$errors->get('password_confirmation')" class="mt-2" />
                            </div>
                        </div>
                    </div>
                </template>

                <template x-if="userRole === 'student'">
                    <div class="space-y-6">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4">{{ __('ព័ត៌មាននិស្សិត') }}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <x-input-label for="student_id_code" class="flex items-center text-lg text-gray-700 font-semibold mb-2"><i class="fas fa-id-card mr-3 text-green-500"></i> {{ __('លេខកូដអត្តសញ្ញាណសិស្ស') }}</x-input-label>
                                <x-text-input id="student_id_code" class="block w-full rounded-xl py-3 px-4" type="text" name="student_id_code" :value="old('student_id_code')" required />
                                <x-input-error :messages="$errors->get('student_id_code')" class="mt-2" />
                            </div>
                            <div>
                                <x-input-label for="program_id" class="flex items-center text-lg text-gray-700 font-semibold mb-2"><i class="fas fa-graduation-cap mr-3 text-green-500"></i> {{ __('កម្មវិធីសិក្សា') }}</x-input-label>
                                <select id="program_id" name="program_id" class="block w-full rounded-xl py-3 px-4" required>
                                    <option value="">{{ __('ជ្រើសរើសកម្មវិធីសិក្សា') }}</option>
                                    @foreach($programs as $program)
                                        <option value="{{ $program->id }}" {{ old('program_id') == $program->id ? 'selected' : '' }}>
                                            {{ $program->name_km ?? $program->name_en }}
                                        </option>
                                    @endforeach
                                </select>
                                <x-input-error :messages="$errors->get('program_id')" class="mt-2" />
                            </div>
                            <div>
                                <x-input-label for="generation" class="flex items-center text-lg text-gray-700 font-semibold mb-2"><i class="fas fa-graduation-cap mr-3 text-green-500"></i> {{ __('ជំនាន់') }}</x-input-label>
                                <x-text-input id="generation" class="block w-full rounded-xl py-3 px-4" type="number" name="generation" :value="old('generation')" required placeholder="16"/>
                                <x-input-error :messages="$errors->get('generation')" class="mt-2" />
                            </div>
                        </div>
                    </div>
                </template>

                <template x-if="userRole === 'professor'">
                    <div class="space-y-6 mt-6">
                        <h4 class="text-2xl font-bold text-gray-800 mb-4">{{ __('ព័ត៌មានសាស្ត្រាចារ្យ') }}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <x-input-label for="faculty_id" class="flex items-center text-lg text-gray-700 font-semibold mb-2"><i class="fas fa-university mr-3 text-green-500"></i> {{ __('មហាវិទ្យាល័យ') }}</x-input-label>
                                <select id="faculty_id" name="faculty_id" class="block w-full rounded-xl py-3 px-4" @change="updateDepartments($event.target.value)"> 
                                    <option value="">{{ __('ជ្រើសរើសមហាវិទ្យាល័យជាមុនសិន') }}</option>
                                    @foreach($faculties as $faculty)
                                        <option value="{{ $faculty->id }}">{{ $faculty->name_km ?? $faculty->name_en }}</option>
                                    @endforeach
                                </select>
                            </div>
                            <div>
                                <x-input-label for="department_id" class="flex items-center text-lg text-gray-700 font-semibold mb-2"><i class="fas fa-building mr-3 text-green-500"></i> {{ __('ដេប៉ាតឺម៉ង់') }}</x-input-label>
                                <select id="department_id" name="department_id" class="block w-full rounded-xl py-3 px-4" required>
                                    <option value="">{{ __('សូមជ្រើសរើសដេប៉ាតឺម៉ង់ជាមុនសិន') }}</option>
                                </select>
                                <x-input-error :messages="$errors->get('department_id')" class="mt-2" />
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <div class="border-t border-gray-200/50 pt-8 mt-8">
                <h4 class="text-2xl font-bold text-gray-800 mb-6">{{ __('ព័ត៌មាន Profile') }}</h4>
                
                <div class="mb-8">
                    <x-input-label class="flex items-center text-lg text-gray-700 font-semibold mb-2">
                        <i class="fas fa-camera-retro mr-3 text-green-500"></i> {{ __('រូបភាព Profile') }}
                    </x-input-label>
                    <div class="mt-2 flex items-center space-x-6">
                        <div class="shrink-0">
                            <img x-show="profilePicturePreview" :src="profilePicturePreview" class="h-20 w-20 rounded-full object-cover shadow-md" alt="Profile preview">
                            <div x-show="!profilePicturePreview" class="h-20 w-20 rounded-full bg-gray-200 flex items-center justify-center text-gray-400">
                                <i class="fas fa-user text-3xl"></i>
                            </div>
                        </div>
                        <label class="block">
                            <input type="file" name="profile_picture" @change="profilePicturePreview = URL.createObjectURL($event.target.files[0])" 
                                class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
                        </label>
                    </div>
                    <x-input-error :messages="$errors->get('profile_picture')" class="mt-2" />
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <x-input-label for="full_name_km" class="flex items-center text-lg text-gray-700 font-semibold mb-2"><i class="fas fa-file-alt mr-3 text-green-500"></i> {{ __('ឈ្មោះពេញ (ខ្មែរ)') }}</x-input-label>
                        <x-text-input id="full_name_km" class="block w-full rounded-xl py-3 px-4" type="text" name="full_name_km" :value="old('full_name_km')" />
                        <x-input-error :messages="$errors->get('full_name_km')" class="mt-2" />
                    </div>
                    <div>
                        <x-input-label for="full_name_en" class="flex items-center text-lg text-gray-700 font-semibold mb-2"><i class="fas fa-file-alt mr-3 text-green-500"></i> {{ __('ឈ្មោះពេញ (អង់គ្លេស)') }}</x-input-label>
                        <x-text-input id="full_name_en" class="block w-full rounded-xl py-3 px-4" type="text" name="full_name_en" :value="old('full_name_en')" />
                        <x-input-error :messages="$errors->get('full_name_en')" class="mt-2" />
                    </div>
                    <div>
                        <x-input-label for="gender" class="flex items-center text-lg text-gray-700 font-semibold mb-2"><i class="fas fa-venus-mars mr-3 text-green-500"></i> {{ __('ភេទ') }}</x-input-label>
                        <select id="gender" name="gender" class="block w-full rounded-xl py-3 px-4">
                            <option value="">{{ __('ជ្រើសរើសភេទ') }}</option>
                            <option value="male" {{ old('gender') == 'male' ? 'selected' : '' }}>{{ __('ប្រុស') }}</option>
                            <option value="female" {{ old('gender') == 'female' ? 'selected' : '' }}>{{ __('ស្រី') }}</option>
                            <option value="other" {{ old('gender') == 'other' ? 'selected' : '' }}>{{ __('ផ្សេងទៀត') }}</option>
                        </select>
                        <x-input-error :messages="$errors->get('gender')" class="mt-2" />
                    </div>
                    <div>
                        <x-input-label for="date_of_birth" class="flex items-center text-lg text-gray-700 font-semibold mb-2"><i class="fas fa-calendar-alt mr-3 text-green-500"></i> {{ __('ថ្ងៃខែឆ្នាំកំណើត') }}</x-input-label>
                        <x-text-input id="date_of_birth" class="block w-full rounded-xl py-3 px-4" type="date" name="date_of_birth" :value="old('date_of_birth')" />
                        <x-input-error :messages="$errors->get('date_of_birth')" class="mt-2" />
                    </div>
                    <div>
                        <x-input-label for="phone_number" class="flex items-center text-lg text-gray-700 font-semibold mb-2"><i class="fas fa-phone mr-3 text-green-500"></i> {{ __('លេខទូរស័ព្ទ') }}</x-input-label>
                        <x-text-input id="phone_number" class="block w-full rounded-xl py-3 px-4" type="text" name="phone_number" :value="old('phone_number')" />
                        <x-input-error :messages="$errors->get('phone_number')" class="mt-2" />
                    </div>
                    <div>
                        <x-input-label for="address" class="flex items-center text-lg text-gray-700 font-semibold mb-2"><i class="fas fa-map-marker-alt mr-3 text-green-500"></i> {{ __('អាសយដ្ឋាន') }}</x-input-label>
                        <x-text-input id="address" class="block w-full rounded-xl py-3 px-4" type="text" name="address" :value="old('address')" />
                        <x-input-error :messages="$errors->get('address')" class="mt-2" />
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-end mt-10">
                <x-primary-button class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-600 to-green-600 border border-transparent rounded-full font-bold text-base text-white hover:from-green-700 hover:to-green-700">
                    <i class="fas fa-user-plus mr-3 text-lg"></i> {{ __('បង្កើតអ្នកប្រើប្រាស់') }}
                </x-primary-button>
            </div>
        </form>
            </div>
        </div>
    </div>
    
    <!-- Script for dependent dropdowns -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const facultySelect = document.getElementById('faculty_id');
            const departmentSelect = document.getElementById('department_id');
            const oldFacultyId = '{{ old('faculty_id') }}';
            const oldDepartmentId = '{{ old('department_id') }}';

            function updateDepartments(facultyId, defaultDepartmentId = null) {
                if (!departmentSelect) return;
                departmentSelect.innerHTML = '<option value="">{{ __("កំពុងទាញយក...") }}</option>';
                departmentSelect.disabled = true;

                if (!facultyId) {
                    departmentSelect.innerHTML = '<option value="">{{ __("សូមជ្រើសរើសមហាវិទ្យាល័យជាមុនសិន") }}</option>';
                    return;
                }

                fetch(`/admin/get-departments-by-faculty/${facultyId}`)
                    .then(response => response.json())
                    .then(departments => {
                        departmentSelect.innerHTML = '<option value="">{{ __("ជ្រើសរើសដេប៉ាតឺម៉ង់") }}</option>';
                        departments.forEach(department => {
                            const option = document.createElement('option');
                            option.value = department.id;
                            option.textContent = department.name_km || department.name_en;
                            if (department.id == defaultDepartmentId) {
                                option.selected = true;
                            }
                            departmentSelect.appendChild(option);
                        });
                        departmentSelect.disabled = false;
                    })
                    .catch(error => console.error('Error fetching departments:', error));
            }

            if (facultySelect) {
                facultySelect.addEventListener('change', function() {
                    updateDepartments(this.value);
                });
                if (oldFacultyId) {
                    updateDepartments(oldFacultyId, oldDepartmentId);
                }
            }
        });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. Toggle Password Visibility Logic ---
        function togglePassword(inputId, buttonId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(buttonId);
            
            if (input && button) {
                button.addEventListener('click', function() {
                    const type = input.type === 'password' ? 'text' : 'password';
                    input.type = type;
                    const icon = this.querySelector('i');
                    // Toggle the eye icon between 'fa-eye' (show) and 'fa-eye-slash' (hide)
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                });
            }
        }

        // Apply toggle to both password fields
        togglePassword('password', 'togglePassword');
        togglePassword('password_confirmation', 'togglePasswordConfirm');

        // --- 2. Password Strength Checker Logic ---
        const passwordInput = document.getElementById('password');
        const strengthText = document.getElementById('password-strength');

        if (passwordInput && strengthText) {
            passwordInput.addEventListener('input', () => {
                const value = passwordInput.value;
                let strength = 0;
                // Criteria checks
                if (/[A-Z]/.test(value)) strength++;       // Uppercase
                if (/[a-z]/.test(value)) strength++;       // Lowercase
                if (/[0-9]/.test(value)) strength++;       // Numbers
                if (/[@$!%*?&]/.test(value)) strength++;   // Symbols
                if (value.length >= 8) strength++;         // Length

                const levels = ['ខ្សោយ', 'មធ្យម', 'ល្អ', 'ខ្លាំង', 'ខ្លាំងណាស់'];
                const colors = ['text-red-400', 'text-yellow-400', 'text-green-400', 'text-green-500', 'text-green-600'];
                
                // Reset classes before setting the new one
                strengthText.className = 'text-sm mt-2'; 
                
                if (value) {
                    const levelIndex = strength > 0 ? strength - 1 : 0;
                    strengthText.textContent = 'កម្លាំងពាក្យសម្ងាត់៖ ' + levels[levelIndex];
                    strengthText.classList.add(colors[levelIndex]);
                } else {
                    strengthText.textContent = '';
                }
            });
        }
    });
    </script>



</x-app-layout>

